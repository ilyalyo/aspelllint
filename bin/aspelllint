#!/usr/bin/env ruby

require 'rubygems'
require 'find'
require 'optparse'
require 'dotsmack'
require 'aspelllint'

def main
  ignores = DEFAULT_IGNORES

  filenames = []

  option = OptionParser.new do |option|
    option.banner = 'Usage: aspelllint [options] [<files>|-]'

    option.on('-i', '--ignore pattern', 'Ignore file pattern (fnmatch)') do |pattern|
      ignores << pattern
    end

    option.on('-h', '--help', 'Print usage info') do
      puts option
      exit
    end

    option.on('-v', '--version', 'Print version info') do
      puts "aspelllint #{Aspelllint::VERSION}"
      exit
    end
  end

  option.parse!

  filenames =
    if ARGV == []
      ['-']
    else
      ARGV
    end

  dotsmack = Dotsmack::Smacker.new(
    dotignore = '.aspelllintignore',
    additional_ignores = ignores
  )

  dotsmack.enumerate(filenames).each do |filename, _|
    if filename == '-'
      check_stdin
    else
      check(filename)
    end
  end
end

begin
  main

#
# User quits aspelllint before completion.
#

rescue Interrupt
  nil
#
# Invalid byte sequence in UTF-8 file.
# Likely a false positive text file.
#
rescue ArgumentError
  nil
#
# aspelllint piped to another program (e.g. `less`),
# which is quit before aspelllint completes.
#
rescue Errno::EPIPE, Errno::EMFILE
  nil
end
